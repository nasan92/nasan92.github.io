---
title: "OAuth 2.0 - Localhost Server Side App Auth Code Flow"
author: Nathanael Santschi
date: 2025-09-27T05:10:21+01:00
draft: true
tags:
  - OAuth
categories:
  - OAuth

  
---

In here a showcase how to create a python Web App which allows to authenticate using Microsoft Entra ID and to authorize access to Microsoft Graph API using the Authorization Code Flow as "confidential client" using a client secret.

## Server Side App - Authorization Code Flow
In this scenario the client is confidential because the app runs only on the server. User has no access to the client secret. 

Here a showcase where the "server side app" (Python Flask App) runs locally and is able to log me in using Microsoft Entra Id + access a Microsoft Graph API. 

## Prerequisites
- Microsoft Azure Tenant
- UV installed: [UV Installation](https://docs.astral.sh/uv/getting-started/installation/)

## Python Flask App
You can find tutorials for this scenario using the MSAL library here: [Microsoft: Python Flask MSAL Tutorial](https://learn.microsoft.com/en-us/entra/identity-platform/tutorial-web-app-python-flask-sign-in-out?tabs=workforce-tenant)

Open a console window, and change to the directory to your Flask web app folder using the command
````bash
cd Flask_App
````

create a new uv project and install necessary dependencies: 
````bash
uv init
uv add flask msal python-dotenv
# activate the virtual environment with those dependencies installed:
source .venv/bin/activate
````

then add the following code:
````python
import logging

logging.basicConfig(level=logging.DEBUG)

from flask import Flask, session, redirect, request, url_for
from dotenv import load_dotenv
import msal
import uuid
import os
import requests

app = Flask(__name__)
app.secret_key = os.urandom(24)  # Needed for session

# Specify the path to the .env file
dotenv_path = ".env"  # Update this with the actual path

# Load the .env file
load_dotenv(dotenv_path=dotenv_path)

# Config
config = {
    "client_id": os.getenv("CLIENT_ID"),
    "authority": f"https://login.microsoftonline.com/{os.getenv('TENANT_ID')}",
    "scope": ["User.Read"],
    "redirect_uri": "http://localhost:5001/callback",
    "client_secret": os.getenv("CLIENT_SECRET"),
}


def build_msal_app():
    return msal.ConfidentialClientApplication(
        client_id=config["client_id"],
        authority=config["authority"],
        client_credential=config["client_secret"],
    )


@app.route("/")
def index():
    if "user" in session:
        user = session["user"]
        return f"""
        <h2>Welcome {user['displayName']}</h2>
        <p>Email: {user.get('mail') or user.get('userPrincipalName')}</p>
        <a href="/logout">Logout</a>
        """
    return '<a href="/login">Login with Microsoft</a>'


@app.route("/login")
def login():
    msal_app = build_msal_app()
    flow = msal_app.initiate_auth_code_flow(
        scopes=config["scope"],
        redirect_uri=config["redirect_uri"],
        state=str(uuid.uuid4()),
    )
    session["auth_flow"] = flow
    return redirect(flow["auth_uri"])


@app.route("/callback")
def callback():
    msal_app = build_msal_app()
    try:
        result = msal_app.acquire_token_by_auth_code_flow(
            session.get("auth_flow", {}), request.args
        )
    except ValueError:
        return "Authentication failed", 400

    if "access_token" in result:
        session["access_token"] = result["access_token"]

        # Call Microsoft Graph to get user info
        graph_resp = requests.get(
            "https://graph.microsoft.com/v1.0/me",
            headers={"Authorization": f"Bearer {result['access_token']}"},
        )
        if graph_resp.ok:
            session["user"] = graph_resp.json()
            return redirect(url_for("index"))
        else:
            return f"Graph API error: {graph_resp.text}", 500

    return f"Error: {result.get('error_description')}", 400


@app.route("/logout")
def logout():
    session.clear()
    return redirect(url_for("index"))


if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5001, debug=True)

````

start the app (login link won't work for now):
````bash
flask --app main.py run --host=0.0.0.0 --port=5001
````

Okay we basically need now to create a registration for our App to make our Login and access of an API working: 

## Create new App Registration
Go to Entra ID and create a new App Registration: 
- **Name:** choose a name which enables you to identify your app
- **Redirect URI:** authentication response will be redirected to this URI

![register application](/images/register-applicaion-myconfidentialserversideapp.png "Preview")

after creating the application we need at least do two other things:
- Create a **Client Secret** (We can use one for server side apps)
- Add Micrsoft Graph API User.Read permissions (if not already there)

Copy the secret immediately and save it to a secure location: 

![create client secret](/images/CreateClientSecret.png "Preview")

Verify that our app has User.Read permissions of the Microsoft Graph API: 

![graph api user read](/images/app-registration-api-permission-confidentialserver.png "Preview")

Create a .env file and add in there your client id and your created client secret:  

`````
TENANT_ID=******************************************
CLIENT_ID=be4099ac-8a21-****************************
CLIENT_SECRET=LFp8Q~********************************
`````

## Login
Okay now restart your flask app and try to click on the login button this time.
It should redirect you to a link which is built out of the following: 

````bash
https://login.microsoftonline.com/YOUR-TENANT-ID/oauth2/v2.0/authorize?
  client_id=YOUR-CLIENT-ID&
  response_type=code&
  redirect_uri=http%3A%2F%2Flocalhost%3A5001%2Fcallback&
  scope=User.Read+offline_access+openid+profile&state=ab75d9bc-3e73-435d-8f6e-12bec5dce5c3&code_challenge=2D2aoAkngNH37eJPvjndhjyvJYhlPdcBUXzfPpQXAuQ&
  code_challenge_method=S256&nonce=40c7a26b0d3c1baac6473580566a7b390459646ccaa8b8be249aa160eee32aaa&client_info=1
````
and there you need to consent the permissions requested: 

![permission-requested](/images/confidential-client-permission-requested.png "Preview")

After consent you come back to our flask app and you can see the welcome page which informations about you. This information was called using the Graph API: 

![welcome-callback](/images/welcome-callback-page.png "Preview")

